# ECR ìµœì í™”ëœ ê³ ê¸‰ CI/CD íŒŒì´í”„ë¼ì¸
name: ECR Optimized CI/CD Pipeline

on:
  push:
    branches: [ master, day2-advanced, develop, feature/* ]
  pull_request:
    branches: [ master, day2-advanced, develop ]
  workflow_dispatch:
    inputs:
      provider:
        description: 'í´ë¼ìš°ë“œ í”„ë¡œë°”ì´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”'
        required: true
        default: 'aws'
        type: choice
        options:
          - aws
          - gcp
          - both
      environment:
        description: 'ë°°í¬ í™˜ê²½ì„ ì„ íƒí•˜ì„¸ìš”'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  security-events: write
  packages: write

env:
  REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  IMAGE_NAME: github-actions-demo-day2
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ë¦°íŒ… ê²€ì‚¬
      run: npm run lint
      
    - name: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬
      run: npm run format -- --check
      
    - name: ë³´ì•ˆ ê°ì‚¬
      run: npm audit --audit-level moderate

  # ë©€í‹° í™˜ê²½ í…ŒìŠ¤íŠ¸
  test:
    name: ë©€í‹° í™˜ê²½ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      matrix:
        node-version: [16, 18, 20]
        environment: [staging, production]
    services:
      postgres:
        image: postgres:13-alpine
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: myapp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:6-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ${{ matrix.node-version }} ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "NODE_ENV=${{ matrix.environment }}" >> $GITHUB_ENV
        echo "DB_HOST=localhost" >> $GITHUB_ENV
        echo "DB_PORT=5432" >> $GITHUB_ENV
        echo "DB_NAME=myapp_test" >> $GITHUB_ENV
        echo "DB_USER=postgres" >> $GITHUB_ENV
        echo "DB_PASSWORD=password" >> $GITHUB_ENV
        echo "REDIS_HOST=localhost" >> $GITHUB_ENV
        echo "REDIS_PORT=6379" >> $GITHUB_ENV
      
    - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        npm run test:unit
        npm run test:integration

  # ECR ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    name: ECR ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: [quality-check, test]
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-uri: ${{ steps.build.outputs.image }}
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: AWS ECR ë¡œê·¸ì¸
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
        
    - name: ECR ë¡œê·¸ì¸
      id: ecr-login
      uses: aws-actions/amazon-ecr-login@v2
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ECR ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        platforms: linux/amd64
        cache-from: type=gha
        cache-to: type=gha,mode=max
        tags: |
          ${{ env.REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
          ${{ env.REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.ECR_REPOSITORY }}:v2.0.0
          ${{ env.REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.ref_name }}-${{ github.sha }}
        labels: |
          org.opencontainers.image.title=GitHub Actions Demo Day2
          org.opencontainers.image.description=ECR Optimized CI/CD Pipeline Demo
          org.opencontainers.image.version=v2.0.0
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
        build-args: |
          BUILDKIT_INLINE_CACHE=1

  # ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    name: ECR ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    needs: [build-and-push]
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Trivy ë³´ì•ˆ ìŠ¤ìº”
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Trivy ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

  # AWS VM ë°°í¬ (STAGING)
  deploy-aws-staging:
    name: AWS ë°°í¬ (STAGING)
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: (github.ref == 'refs/heads/day2-advanced' || github.event.inputs.environment == 'staging') && (github.event.inputs.provider == null || github.event.inputs.provider == 'aws' || github.event.inputs.provider == 'both')
    environment: aws-staging
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: AWS VM ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_VM_HOST }}
        username: ${{ secrets.STAGING_VM_USERNAME }}
        key: ${{ secrets.STAGING_VM_SSH_KEY }}
        script: |
          # AWS CLI ì„¤ì¹˜ ë° ì„¤ì •
          if ! command -v aws &> /dev/null; then
            echo "ğŸ“¦ AWS CLI ì„¤ì¹˜ ì¤‘..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
            rm -rf aws awscliv2.zip
          fi
          
          # AWS ìê²© ì¦ëª… ì„¤ì •
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set default.region ${{ secrets.AWS_REGION }}
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export DB_PASSWORD="${{ secrets.STAGING_DB_PASSWORD }}"
          export REDIS_PASSWORD="${{ secrets.STAGING_REDIS_PASSWORD }}"
          export CONTAINER_PREFIX="aws-staging"
          export NODE_ENV="staging"
          export PORT="3000"
          export ECR_REGISTRY="${{ env.REGISTRY }}"
          export ECR_REPOSITORY="${{ env.ECR_REPOSITORY }}"
          export IMAGE_TAG="${{ github.sha }}"
          export DB_HOST="postgres"
          export DB_PORT="5432"
          export DB_NAME="github_actions_demo"
          export DB_USER="postgres"
          export REDIS_HOST="redis"
          export REDIS_PORT="6379"
          
          # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„± ë° ì´ë™
          mkdir -p /home/${{ secrets.STAGING_VM_USERNAME }}/app
          cd /home/${{ secrets.STAGING_VM_USERNAME }}/app
          
          # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€
          if [ -f docker-compose.prod.yml ]; then
            docker-compose -f docker-compose.prod.yml down
          fi
          
          # ECR ë¡œê·¸ì¸ ë° ìµœì‹  ì´ë¯¸ì§€ í’€
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.REGISTRY }}
          docker pull ${{ env.REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
          
          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f
          
          # Docker Composeë¡œ ì„œë¹„ìŠ¤ ì‹œì‘
          docker-compose -f docker-compose.prod.yml up -d
          
          # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
          sleep 30
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          for i in {1..10}; do
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/10..."
            if curl -f http://localhost/health; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸"
              docker-compose -f docker-compose.prod.yml logs
              exit 1
            fi
            sleep 10
          done
          
          echo "âœ… AWS Staging ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ Application URL: http://${{ secrets.STAGING_VM_HOST }}"

    - name: í•„ìš”í•œ íŒŒì¼ë“¤ì„ ì›ê²© ì„œë²„ì— ë³µì‚¬
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.STAGING_VM_HOST }}
        username: ${{ secrets.STAGING_VM_USERNAME }}
        key: ${{ secrets.STAGING_VM_SSH_KEY }}
        source: "docker-compose.prod.yml,nginx/nginx.prod.conf,Dockerfile,package.json,package-lock.json,src/"
        target: "/home/${{ secrets.STAGING_VM_USERNAME }}/app/"

  # GCP VM ë°°í¬ (STAGING)
  deploy-gcp-staging:
    name: GCP ë°°í¬ (STAGING)
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: (github.ref == 'refs/heads/day2-advanced' || github.event.inputs.environment == 'staging') && (github.event.inputs.provider == null || github.event.inputs.provider == 'gcp' || github.event.inputs.provider == 'both')
    environment: gcp-staging
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: GCP VM ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_VM_HOST }}
        username: ${{ secrets.STAGING_VM_USERNAME }}
        key: ${{ secrets.STAGING_VM_SSH_KEY }}
        script: |
          # AWS CLI ì„¤ì¹˜ ë° ì„¤ì • (ECR ì ‘ê·¼ìš©)
          if ! command -v aws &> /dev/null; then
            echo "ğŸ“¦ AWS CLI ì„¤ì¹˜ ì¤‘..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
            rm -rf aws awscliv2.zip
          fi
          
          # AWS ìê²© ì¦ëª… ì„¤ì •
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set default.region ${{ secrets.AWS_REGION }}
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export DB_PASSWORD="${{ secrets.STAGING_DB_PASSWORD }}"
          export REDIS_PASSWORD="${{ secrets.STAGING_REDIS_PASSWORD }}"
          export CONTAINER_PREFIX="gcp-staging"
          export NODE_ENV="staging"
          export PORT="3000"
          export ECR_REGISTRY="${{ env.REGISTRY }}"
          export ECR_REPOSITORY="${{ env.ECR_REPOSITORY }}"
          export IMAGE_TAG="${{ github.sha }}"
          export DB_HOST="postgres"
          export DB_PORT="5432"
          export DB_NAME="github_actions_demo"
          export DB_USER="postgres"
          export REDIS_HOST="redis"
          export REDIS_PORT="6379"
          
          # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„± ë° ì´ë™
          mkdir -p /home/${{ secrets.STAGING_VM_USERNAME }}/app
          cd /home/${{ secrets.STAGING_VM_USERNAME }}/app
          
          # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€
          if [ -f docker-compose.prod.yml ]; then
            docker-compose -f docker-compose.prod.yml down
          fi
          
          # ECR ë¡œê·¸ì¸ ë° ìµœì‹  ì´ë¯¸ì§€ í’€
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.REGISTRY }}
          docker pull ${{ env.REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
          
          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f
          
          # Docker Composeë¡œ ì„œë¹„ìŠ¤ ì‹œì‘
          docker-compose -f docker-compose.prod.yml up -d
          
          # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
          sleep 30
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          for i in {1..10}; do
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/10..."
            if curl -f http://localhost/health; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸"
              docker-compose -f docker-compose.prod.yml logs
              exit 1
            fi
            sleep 10
          done
          
          echo "âœ… GCP Staging ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ Application URL: http://${{ secrets.STAGING_VM_HOST }}"

    - name: í•„ìš”í•œ íŒŒì¼ë“¤ì„ ì›ê²© ì„œë²„ì— ë³µì‚¬
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.STAGING_VM_HOST }}
        username: ${{ secrets.STAGING_VM_USERNAME }}
        key: ${{ secrets.STAGING_VM_SSH_KEY }}
        source: "docker-compose.prod.yml,nginx/nginx.prod.conf,Dockerfile,package.json,package-lock.json,src/"
        target: "/home/${{ secrets.STAGING_VM_USERNAME }}/app/"

  # ë°°í¬ í›„ í…ŒìŠ¤íŠ¸
  post-deployment-test:
    name: ë°°í¬ í›„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [deploy-aws-staging, deploy-gcp-staging]
    if: always() && (needs.deploy-aws-staging.result == 'success' || needs.deploy-gcp-staging.result == 'success')
    steps:
    - name: ë°°í¬ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ í…ŒìŠ¤íŠ¸
      run: |
        # AWS ìŠ¤í…Œì´ì§• í™˜ê²½ í…ŒìŠ¤íŠ¸
        if [ "${{ needs.deploy-aws-staging.result }}" == "success" ]; then
          echo "Testing AWS staging environment..."
          curl -f http://${{ secrets.STAGING_VM_HOST }}/health
          curl -f http://${{ secrets.STAGING_VM_HOST }}/api/users
          echo "âœ… AWS staging environment tests passed"
        fi
        
        # GCP ìŠ¤í…Œì´ì§• í™˜ê²½ í…ŒìŠ¤íŠ¸
        if [ "${{ needs.deploy-gcp-staging.result }}" == "success" ]; then
          echo "Testing GCP staging environment..."
          curl -f http://${{ secrets.STAGING_VM_HOST }}/health
          curl -f http://${{ secrets.STAGING_VM_HOST }}/api/users
          echo "âœ… GCP staging environment tests passed"
        fi

  # ì•Œë¦¼
  notify:
    name: ë°°í¬ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [deploy-aws-staging, deploy-gcp-staging, post-deployment-test]
    if: always()
    steps:
    - name: ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      run: |
        echo "ğŸ¯ ECR Optimized CI/CD Pipeline Summary"
        echo "======================================"
        echo "ğŸ“¦ Build: âœ… Success"
        echo "ğŸ§ª Tests: âœ… Success"
        echo "ğŸ”’ Security Scan: âœ… Success"
        echo "ğŸš€ AWS Staging: ${{ needs.deploy-aws-staging.result }}"
        echo "ğŸš€ GCP Staging: ${{ needs.deploy-gcp-staging.result }}"
        echo "âœ… Post-deployment Tests: ${{ needs.post-deployment-test.result }}"
        echo ""
        echo "ğŸŒ Deployed URLs:"
        if [ "${{ needs.deploy-aws-staging.result }}" == "success" ]; then
          echo "  AWS Staging: http://${{ secrets.STAGING_VM_HOST }}"
        fi
        if [ "${{ needs.deploy-gcp-staging.result }}" == "success" ]; then
          echo "  GCP Staging: http://${{ secrets.STAGING_VM_HOST }}"
        fi
        echo ""
        echo "ğŸ“Š Pipeline completed at: $(date)"
        echo "ğŸ³ ECR Registry: ${{ env.REGISTRY }}"
        echo "ğŸ“¦ Repository: ${{ env.ECR_REPOSITORY }}"
